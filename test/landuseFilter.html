<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Filter Land Use</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.14/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
        
      #landuse-filter {
        height: 160px;
        width: 100%;
        visibility: hidden;
      }

      .landuse-item {
        width: 100%;
        padding: 12px;
        text-align: center;
        vertical-align: baseline;
        cursor: pointer;
        height: 40px;
      }

      .landuse-item:focus {
        background-color: dimgrey;
      }

      .landuse-item:hover {
        background-color: dimgrey;
      }
    </style>
    <script>
      require([
        "esri/views/MapView",
        "esri/Map",
        "esri/layers/FeatureLayer",
        "esri/widgets/Expand"
      ], function(MapView, Map, FeatureLayer, Expand) {
          
        // Initialize variables
        let parcelLayerView;
        
        // land use layer
        const landuseLayer = new FeatureLayer({
            url: "https://maps.trpa.org/server/rest/services/Verify_Existing_Land_Use/FeatureServer",
            outFields: ["TRPA_LANDUSE_DESCRIPTION"]
        });
          
        // map
        const map = new Map({
          basemap: "gray-vector",
          layers: [ landuseLayer]
        });

        // view
        const view = new MapView({
          map: map,
          container: "viewDiv",
          center: [-120.01,39.05],
          zoom: 10
        });
        
          
        const landuseNodes = document.querySelectorAll(`.landuse-item`);
        const landuseElement = document.getElementById("landuse-filter");

        // click event handler for landuse choices
        landuseElement.addEventListener("click", filterByLandUse);

        // User clicked on landuse to set an attribute filter
        function filterByLandUse(event) {
          const selectedLanduse = event.target.getAttribute("data-landuse");
          parcelLayerView.filter = {
            where: "TRPA_LANDUSE_DESCRIPTION" + selectedLanduse
          };
        }
        
        // after land use layer loads create the widget
        view.whenLayerView(landuseLayer).then(function(layerView) {
          // land use layer loaded
          // get a reference to the land use layerview
          parcelLayerView = layerView;

        // set up UI items
        landuseElement.style.visibility = "visible";
        
        const landuseExpand = new Expand({
            view: view,
            content: landuseElement,
            expandIconClass: "esri-icon-filter",
            group: "top-left"
          });
        
        //clear the filters when user closes the expand widget
        landuseExpand.watch("expanded", function() {
            if (!landuseExpand.expanded) {
              parcelLayerView.filter = null;
            }
          });
        view.ui.add(landuseExpand, "top-left");
        });
      }); 
    </script>
  </head>

  <body>

    <div id="viewDiv"></div>
    <div id="landuse-filter" class="esri-widget">
      <div class="landuse-item visible-landuse" data-landuse= " = 'Vacant'">Vacant</div>
      <div class="landuse-item visible-landuse" data-landuse= " IN ('Single Family Residential', 'Multi-Family Residential','Condominium
', 'Condominium Common Area')">Residential</div>
      <div class="landuse-item visible-landuse" data-landuse= " IN ('Commercial', 'Mixed Use', 'Tourist Accommodation')">Commercial</div>
              <div class="landuse-item visible-landuse" data-landuse= " IN ('Open Space', 'Recreation', 'Public Service')">Public</div>
    </div>

  </body>
</html>
