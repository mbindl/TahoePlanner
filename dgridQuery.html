<!DOCTYPE html>
<html dir="ltr">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
  <title>Related Table</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.10/esri/css/main.css">
  <script src="https://js.arcgis.com/4.10/"></script>

  <style>
    html,
    body,
    #viewDiv {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .dgrid-header,
    .dgrid-header-row {
      background-color: #eee;
      color: #57585A;
    }

    .dgrid-row-even {
      background-color: #F7F8F8;
    }

    .dgrid-row-odd {
      background-color: #EFEFEF;
    }

    .dgrid-row {
      border: none
    }

    .dgrid {
      height: 10em;
      width: 600px;
    }

    #gridDisplay {
      position: absolute;
      background-color: white;
      border-color: grey;
      font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 14px;
      display: none;
      bottom: 20px;
      left: 10px;
      z-index: 1000;
      padding: 1em;
      max-height: 400px;
      max-width: 600px;
      overflow-x: auto;
    }
  </style>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/tasks/support/Query",
      "esri/tasks/QueryTask",
      "esri/tasks/support/RelationshipQuery",
      "dojo/_base/declare",
      "dgrid/OnDemandGrid",
      "dgrid/extensions/ColumnResizer",
      "dojo/store/Memory",
      "dstore/legacy/StoreAdapter",
      "dojo/dom-class",
      "dojo/date/locale"
    ], function(Map, MapView, FeatureLayer, Query, QueryTask, RelationshipQuery, declare,
      OnDemandGrid, ColumnResizer, Memory, StoreAdapter, domClass, locale) {

      let grid;
      let gridFields = ["Use_Type", "Use_Status", "Density", "Unit","Notes"
      ];

      const gridDis = document.getElementById("gridDisplay");

      const dataStore = new StoreAdapter({
        objectStore: new Memory({
          idProperty: "ZONING_ID"
        })
      });

      // setup the map
      var map = new Map({
        basemap: "streets"
      });
      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-120.01,38.925],
        zoom: 13
      });


      var zones = new FeatureLayer({
        url: "https://maps.trpa.org/server/rest/services/Zoning/MapServer/0",
        outFields: ["*"]
      });
      map.add(zones);

      view.on("click", function(evt) {
        view.hitTest(evt).then(function(response) {
          if (response.results.length) {
            var graphic = response.results.filter(function(result) {
              // check if the graphic belongs to the layer of interest
              return result.graphic.layer === zones;
            })[0].graphic;
            if (graphic) {
              queryRelated(graphic);
            }
          }
        })
      });

      function createGrid(columns) {
        grid = new (declare([ OnDemandGrid, ColumnResizer ]))({
          columns: columns
        }, "grid");
      }

      function doClear() {
        if(grid){
          dataStore.objectStore.data = {};
          grid.set("collection", dataStore);
        }
        // gridDis.style.display = 'none';
      }

      function queryRelated(gra) {
        doClear();
        var feature = gra;
        var relatedOWBEOQuery = new RelationshipQuery();
        relatedOWBEOQuery.outFields = ["*"];
        relatedOWBEOQuery.relationshipId = 0;
        relatedOWBEOQuery.objectIds = [feature.attributes[zones.objectIdField]];
        zones.queryRelatedFeatures(relatedOWBEOQuery).then(function(relatedRecords) {
          var fset = relatedRecords[feature.attributes[zones.objectIdField]];
          if (fset.features.length > 0) {
            gridDis.style.display = 'block';
            var results = [];
            for (i = 0; i < fset.features.length; i++) {
              results.push(fset.features[i].attributes);
            }
            var columns =  [{
                field: 'Use_Type',
                label: 'Use',
                sortable: true,
              },{
                field: 'Use_Status',
                label: 'Use Status',
                sortable: true,
              },{
                field: 'Density',
                label: 'Density',
                sortable: true,
              },{
                field: 'Unit',
                label: 'Unit',
                sortable: true,
              },{
                field: 'Notes',
                label: 'Notes',
                sortable: false,
              }];
            createGrid(columns);

            // get the attributes to display in the grid
            var data = fset.features.map(function(feature, i) {
              return Object.keys(feature.attributes)
                .filter(function(key) {
                  // get fields that exist in the grid
                  return (gridFields.indexOf(key) !== -1);
                })
                // need to create key value pairs from the feature
                // attributes so that info can be displayed in the grid
                .reduce((obj, key) => {
                  obj[key] = feature.attributes[key];
                  return obj;
                }, {});
            });

            // set the datastore for the grid using the
            // attributes we got for the query results
            dataStore.objectStore.data = data;
            grid.set("collection", dataStore);
          }
        });
      }
    });
  </script>

</head>

<body>
  <div id="viewDiv">
    <div id="gridDisplay">
       <button class="button" onclick="document.getElementById('gridDisplay').style.display='none'" >x</button>
      <div id="grid"></div>
    </div>
  </div>
</body>

</html>